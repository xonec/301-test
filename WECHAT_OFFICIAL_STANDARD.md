# å¾®ä¿¡å®˜æ–¹æ ‡å‡† - å¤´åƒæ˜µç§°å¡«å†™å®ç°

## ğŸ“– æ¦‚è¿°

æœ¬é¡¹ç›®å·²å‡çº§ä¸ºä½¿ç”¨å¾®ä¿¡å®˜æ–¹æ¨èçš„å¤´åƒæ˜µç§°å¡«å†™èƒ½åŠ›ï¼Œå‚è€ƒè‡ªï¼š
https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html

## âœ¨ ä¸»è¦æ”¹è¿›

### æ—§å®ç°ï¼ˆå·²åºŸå¼ƒï¼‰
- âŒ ä½¿ç”¨ `wx.getUserProfile()` è·å–ç”¨æˆ·æˆæƒ
- âŒ ä½¿ç”¨ `wx.chooseMedia()` é€‰æ‹©å¤´åƒæ–‡ä»¶
- âŒ éœ€è¦ä¸Šä¼ å¤´åƒåˆ°æœåŠ¡å™¨

### æ–°å®ç°ï¼ˆå®˜æ–¹æ ‡å‡†ï¼‰
- âœ… ä½¿ç”¨ `<button open-type="chooseAvatar">` è®©ç”¨æˆ·é€‰æ‹©å¤´åƒ
- âœ… ä½¿ç”¨ `<input type="nickname">` è®©ç”¨æˆ·å¡«å†™æ˜µç§°
- âœ… å¾®ä¿¡å†…ç½®å®‰å…¨æ£€æµ‹ï¼ˆè¿‡æ»¤éæ³•å†…å®¹ï¼‰
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œäº¤äº’æµç¨‹

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¤´åƒé€‰æ‹© - chooseAvatar

```wxml
<!-- ç™»å½•é¡µé¢ï¼šæ³¨å†Œæ—¶é€‰æ‹©å¤´åƒ -->
<button
  class="avatar-button"
  open-type="chooseAvatar"
  bind:chooseavatar="onChooseAvatar"
>
  <image class="avatar-img" src="{{ registerForm.avatarUrl }}" mode="aspectFill" />
</button>
```

```javascript
// JS å¤„ç†
onChooseAvatar(e) {
  const { avatarUrl } = e.detail;
  this.setData({ 'registerForm.avatarUrl': avatarUrl });
}
```

**ç‰¹ç‚¹**ï¼š
- ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ç›´æ¥å¼¹å‡ºå¤´åƒé€‰æ‹©ç•Œé¢
- è¿”å›çš„æ˜¯å¤´åƒçš„**ä¸´æ—¶è·¯å¾„**æˆ–**ç½‘ç»œ URL**
- è‡ªåŠ¨è¿‡æ»¤éæ³•å›¾ç‰‡ï¼ˆåŸºç¡€åº“ 2.24.4+ï¼‰

### æ˜µç§°è¾“å…¥ - nickname input

```wxml
<!-- ç™»å½•é¡µé¢ï¼šæ³¨å†Œæ—¶å¡«å†™æ˜µç§° -->
<input
  type="nickname"
  placeholder="è¯·è¾“å…¥æ˜µç§°"
  value="{{ registerForm.nickName }}"
  bindinput="onNickNameInput"
  maxlength="20"
/>
```

```javascript
// JS å¤„ç†
onNickNameInput(e) {
  this.setData({ 'registerForm.nickName': e.detail.value });
}
```

**ç‰¹ç‚¹**ï¼š
- è¾“å…¥æ¡†ä¸Šæ–¹æ˜¾ç¤ºå¾®ä¿¡æ˜µç§°å»ºè®®
- è‡ªåŠ¨è¿‡æ»¤éæ³•æ–‡æœ¬ï¼ˆåŸºç¡€åº“ 2.24.4+ï¼‰
- ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¾®ä¿¡æ˜µç§°æˆ–è‡ªå®šä¹‰æ˜µç§°

### è¡¨å•æäº¤

```wxml
<!-- ä½¿ç”¨ form ç»„ä»¶åŒ…è£…è¾“å…¥ -->
<form bindsubmit="onRegisterSubmit" class="register-form">
  <!-- å¤´åƒå’Œæ˜µç§°è¾“å…¥ -->
  <button form-type="submit" disabled="{{ !registerForm.nickName || !registerForm.avatarUrl }}">
    å®Œæˆæ³¨å†Œ
  </button>
</form>
```

```javascript
// JS å¤„ç†è¡¨å•æäº¤
async onRegisterSubmit(e) {
  const { nickName, avatarUrl } = this.data.registerForm;
  
  if (!nickName || !avatarUrl) {
    return; // è¡¨å•å·²ç¦ç”¨
  }
  
  // è°ƒç”¨åå° updateUser API
  const result = await authService.updateUser(nickName, avatarUrl);
}
```

## ğŸ“± åº”ç”¨æµç¨‹

### æ³¨å†Œæµç¨‹

```
ç”¨æˆ·è¿›å…¥æ³¨å†Œé¡µé¢
    â†“
ç‚¹å‡»å¤´åƒæŒ‰é’® â†’ å¾®ä¿¡å¼¹å‡ºå¤´åƒé€‰æ‹©ç•Œé¢
    â†“
é€‰æ‹©å¤´åƒ â†’ onChooseAvatar å›è°ƒè·å– avatarUrl
    â†“
å¡«å†™æ˜µç§° â†’ onNickNameInput å®æ—¶æ›´æ–°æ•°æ®
    â†“
ç‚¹å‡»æäº¤æŒ‰é’® â†’ è¡¨å•æäº¤
    â†“
è°ƒç”¨ /api/login/updateUser ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    â†“
æ³¨å†Œå®Œæˆï¼Œè·³è½¬åˆ°ä¸»é¡µé¢
```

### ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯æµç¨‹

```
ç”¨æˆ·è¿›å…¥ä¸ªäººä¸­å¿ƒ
    â†“
ç‚¹å‡»"ç¼–è¾‘ä¸ªäººä¿¡æ¯" â†’ è¿›å…¥ç¼–è¾‘æ¨¡å¼
    â†“
ç”¨æˆ·å¯ä»¥é‡æ–°é€‰æ‹©å¤´åƒ â†’ onChooseAvatar
    â†“
ç”¨æˆ·å¯ä»¥ä¿®æ”¹æ˜µç§° â†’ onNickNameInput
    â†“
ç‚¹å‡»"ä¿å­˜ä¿®æ”¹" â†’ è¡¨å•æäº¤
    â†“
è°ƒç”¨ /api/login/updateUser æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    â†“
è¿”å›ä¸ªäººä¸­å¿ƒï¼Œåˆ·æ–°æ˜¾ç¤ºæ–°ä¿¡æ¯
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### å¾®ä¿¡å†…ç½®å®‰å…¨æ£€æµ‹

- **å›¾ç‰‡æ£€æµ‹**ï¼šè‡ªåŠ¨è¿‡æ»¤éæ³•æˆ–ä¸å½“çš„å¤´åƒå›¾ç‰‡
- **æ–‡æœ¬æ£€æµ‹**ï¼šè‡ªåŠ¨è¿‡æ»¤éæ³•æˆ–ä¸å½“çš„æ˜µç§°æ–‡æœ¬
- **æ™ºèƒ½è¯†åˆ«**ï¼šè¯†åˆ«æ¶‰é»„ã€æ¶‰æš´ç­‰ä¸å½“å†…å®¹

### å®ç°çº§åˆ«

| åŸºç¡€åº“ç‰ˆæœ¬ | åŠŸèƒ½ |
|----------|------|
| 2.21.2+ | æ”¯æŒ chooseAvatar å’Œ nickname input |
| 2.24.4+ | æ–°å¢å†…å®¹å®‰å…¨æ£€æµ‹ï¼ˆmediaCheckAsyncã€msgSecCheckï¼‰ |

**å½“å‰é¡¹ç›®çš„æœ€ä½è¦æ±‚**ï¼šåŸºç¡€åº“ 2.21.2+

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `pages/login/login.wxml` | ä½¿ç”¨ chooseAvatar æŒ‰é’®å’Œ nickname input |
| `pages/login/login.js` | æ–°å¢ onChooseAvatarã€onNickNameBlurã€onRegisterSubmit |
| `pages/login/login.wxss` | æ–°å¢ .avatar-buttonã€.avatar-imgã€.avatar-hint æ ·å¼ |
| `pages/user/user.wxml` | æ–°å¢ç¼–è¾‘æ¨¡å¼ UI |
| `pages/user/user.js` | é‡å†™ç¼–è¾‘é€»è¾‘ï¼Œæ”¯æŒ chooseAvatar |
| `pages/user/user.wxss` | æ–°å¢ç¼–è¾‘æ¨¡å¼æ ·å¼ |

### æ ¸å¿ƒ API

æ‰€æœ‰æ”¹åŠ¨éƒ½åŸºäºä»¥ä¸‹æ ¸å¿ƒå‡½æ•°ï¼š
- `authService.updateUser(nickname, avatarUrl)` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯

## ğŸš€ ä½¿ç”¨æŒ‡å—

### ç”¨æˆ·æ“ä½œ

#### æ³¨å†Œæ–°ç”¨æˆ·

1. è¿›å…¥ç™»å½•é¡µé¢ï¼Œåˆ‡æ¢åˆ°"æ³¨å†Œ"é€‰é¡¹å¡
2. ç‚¹å‡»å¤´åƒåŒºåŸŸï¼Œå¼¹å‡ºå¾®ä¿¡å¤´åƒé€‰æ‹©å™¨
3. é€‰æ‹©æˆ–æ‹æ‘„å¤´åƒ
4. åœ¨æ˜µç§°è¾“å…¥æ¡†å¡«å†™æ˜µç§°
5. ç‚¹å‡»"å®Œæˆæ³¨å†Œ"æŒ‰é’®

#### ç¼–è¾‘ç°æœ‰ç”¨æˆ·ä¿¡æ¯

1. è¿›å…¥"æˆ‘çš„"é¡µé¢ï¼ˆç”¨æˆ·ä¸­å¿ƒï¼‰
2. ç‚¹å‡»"ç¼–è¾‘ä¸ªäººä¿¡æ¯"æŒ‰é’®
3. ç‚¹å‡»å¤´åƒæŒ‰é’®æ›´æ¢å¤´åƒ
4. ä¿®æ”¹æ˜µç§°ï¼ˆå¯é€‰ï¼‰
5. ç‚¹å‡»"ä¿å­˜ä¿®æ”¹"æŒ‰é’®

### å¼€å‘è€…è°ƒç”¨

```javascript
// åœ¨ä»»ä½•éœ€è¦æ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„åœ°æ–¹
const result = await authService.updateUser(nickName, avatarUrl);

if (result.success) {
  console.log('æ›´æ–°æˆåŠŸ:', result.data);
} else {
  console.log('æ›´æ–°å¤±è´¥:', result.error);
}
```

## âš ï¸ å…¼å®¹æ€§è¯´æ˜

### æ”¯æŒæƒ…å†µ

- âœ… iOS: æ”¯æŒï¼ˆåŸºç¡€åº“ 2.21.2+ï¼‰
- âœ… Android: æ”¯æŒï¼ˆåŸºç¡€åº“ 2.21.2+ï¼‰
- âœ… å¾®ä¿¡å¼€å‘è€…å·¥å…·: æ”¯æŒï¼ˆéœ€è¦æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰

### ä¸æ”¯æŒæƒ…å†µ

- âŒ æ—§ç‰ˆåŸºç¡€åº“ï¼ˆ<2.21.2ï¼‰ï¼šä¸æ”¯æŒ chooseAvatar
- âŒ æ—§ç‰ˆå¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼šéœ€è¦æ›´æ–°

### é™çº§æ–¹æ¡ˆ

å¦‚æœç”¨æˆ·è®¾å¤‡çš„åŸºç¡€åº“ç‰ˆæœ¬è¿‡è€ï¼Œå¯ä»¥æç¤ºç”¨æˆ·æ›´æ–°å¾®ä¿¡å®¢æˆ·ç«¯ï¼š

```javascript
// æ£€æŸ¥åŸºç¡€åº“ç‰ˆæœ¬
const systemInfo = wx.getSystemInfoSync();
if (systemInfo.SDKVersion < '2.21.2') {
  wx.showModal({
    title: 'æç¤º',
    content: 'è¯·æ›´æ–°å¾®ä¿¡å®¢æˆ·ç«¯ä»¥ä½¿ç”¨æœ€æ–°åŠŸèƒ½',
    showCancel: false
  });
}
```

## ğŸ¨ UI/UX æ”¹è¿›

### å¤´åƒé€‰æ‹©

- **æŒ‰é’®è®¾è®¡**ï¼šè™šçº¿è¾¹æ¡†ï¼Œä¸­å¿ƒæ˜¾ç¤ºå½“å‰å¤´åƒ
- **è§†è§‰åé¦ˆ**ï¼šæŒ‰ä¸‹æ—¶æœ‰ç¼©æ”¾åŠ¨ç”»
- **æ˜“ç”¨æ€§**ï¼šä¸€é”®å¼æ“ä½œï¼Œæ— éœ€é¢å¤–æ­¥éª¤

### æ˜µç§°è¾“å…¥

- **è¾“å…¥æç¤º**ï¼šé”®ç›˜ä¸Šæ–¹æ˜¾ç¤ºå¾®ä¿¡æ˜µç§°å»ºè®®
- **å­—ç¬¦è®¡æ•°**ï¼šå®æ—¶æ˜¾ç¤ºå·²è¾“å…¥å­—ç¬¦æ•°
- **é™åˆ¶**ï¼šæœ€å¤š 20 ä¸ªå­—ç¬¦

### ç¼–è¾‘ä½“éªŒ

- **ä¸¤ç§æ¨¡å¼**ï¼šæŸ¥çœ‹æ¨¡å¼å’Œç¼–è¾‘æ¨¡å¼åˆ†ç¦»
- **ç¼–è¾‘ç•Œé¢**ï¼šæ¸å˜èƒŒæ™¯ï¼Œä¸ç™»å½•é¡µé¢é£æ ¼ä¸€è‡´
- **æ“ä½œåé¦ˆ**ï¼šæŒ‰é’®æœ‰åŠ è½½çŠ¶æ€å’Œç¦ç”¨çŠ¶æ€

## ğŸ“š å‚è€ƒèµ„æº

- å®˜æ–¹æ–‡æ¡£ï¼šhttps://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html
- åŸºç¡€åº“æ›´æ–°ï¼šhttps://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html
- å†…å®¹å®‰å…¨ï¼šhttps://developers.weixin.qq.com/miniprogram/dev/api/cloudbase/security.html

## ğŸ”„ è¿ç§»æŒ‡å—

å¦‚æœä½ çš„é¡¹ç›®ä¹‹å‰ä½¿ç”¨äº†æ—§çš„å®ç°ï¼Œè¿ç§»æ­¥éª¤ï¼š

1. **æ›´æ–° WXML**ï¼šä½¿ç”¨ chooseAvatar æŒ‰é’®ä»£æ›¿ tap äº‹ä»¶
2. **æ›´æ–° JS**ï¼šç§»é™¤æ—§çš„ wx.chooseMedia å’Œä¸Šä¼ é€»è¾‘
3. **æ›´æ–° WXSS**ï¼šåº”ç”¨æ–°çš„æ ·å¼è§„åˆ™
4. **æµ‹è¯•**ï¼šåœ¨çœŸæœºä¸Šæµ‹è¯•æ‰€æœ‰åŠŸèƒ½
5. **å‘å¸ƒ**ï¼šæ›´æ–°ç‰ˆæœ¬å¹¶å‘å¸ƒ

## âœ… æ£€æŸ¥æ¸…å•

- [x] ç™»å½•/æ³¨å†Œé¡µé¢ä½¿ç”¨ chooseAvatar
- [x] æ˜µç§°è¾“å…¥ä½¿ç”¨ nickname input
- [x] ç¼–è¾‘é¡µé¢æ”¯æŒä¿®æ”¹å¤´åƒå’Œæ˜µç§°
- [x] è¡¨å•æäº¤æ­£ç¡®å¤„ç†éªŒè¯
- [x] åå° updateUser API é›†æˆ
- [x] æœ¬åœ°æ•°æ®å­˜å‚¨æ›´æ–°
- [x] åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º
- [x] æ ·å¼å’Œ UI æ›´æ–°
- [x] æ–‡æ¡£å’Œæ³¨é‡Šå®Œæ•´

---

**æœ€åæ›´æ–°**ï¼š2024-11-28  
**çŠ¶æ€**ï¼šâœ… å·²å‡çº§ä¸ºå¾®ä¿¡å®˜æ–¹æ ‡å‡†å®ç°
